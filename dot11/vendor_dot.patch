From ae01a01da5b952f03bb5f62de691897e8f952970 Mon Sep 17 00:00:00 2001
From: Danny Lin <danny@kdrag0n.dev>
Date: Sun, 13 Dec 2020 18:48:48 -0800
Subject: [PATCH 1/5] wifi: Increase 5 GHz network signal tolerance

On devices with cellular data available, I've been experiencing Wi-Fi
dropouts on 5 GHz networks where it disconnects and falls back to
cellular data around a RSSI of -77 dBm. While the Wi-Fi quality may not
be ideal at this signal level, it is still better to stay on it than
switch to cellular data because switching networks can be very
disruptive to the user.

To make matters worse, the signal tends to oscillate around -77 dBm in
my case, which causes it to oscillate between Wi-Fi and cellular data
every few seconds. This causes far more disruptions than staying on weak
Wi-Fi would.

These signal levels were measured empirically on a Pixel 5, but they
should apply to most devices. 2.4 GHz values were found to be more or
less accurate, but 5 GHz networks continued to work past the AOSP
thresholds. The iPhone 6s was also content with these signal levels and
still displayed 2 of 3 signal levels at -77 dBm.

Signed-off-by: Albert I <kras@raphielgang.org>
---
 .../net/wifi/service/res/values/config.xml    | 24 +++++++++++++++++++
 1 file changed, 24 insertions(+)
 create mode 100644 overlay/frameworks/opt/net/wifi/service/res/values/config.xml

diff --git a/overlay/frameworks/opt/net/wifi/service/res/values/config.xml b/overlay/frameworks/opt/net/wifi/service/res/values/config.xml
new file mode 100644
index 00000000..746f8cea
--- /dev/null
+++ b/overlay/frameworks/opt/net/wifi/service/res/values/config.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+    Copyright (C) 2020 The Proton AOSP Project
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+        http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<resources>
+    <!-- Integer parameters of the wifi to cellular handover feature
+         wifi should not stick to bad networks -->
+    <!-- Integer threshold for low network score, should be somewhat less than the entry threshhold -->
+    <integer translatable="false" name="config_wifi_framework_wifi_score_bad_rssi_threshold_5GHz">-90</integer>
+    <!-- Integer threshold, do not connect to APs with RSSI lower than the entry threshold -->
+    <integer translatable="false" name="config_wifi_framework_wifi_score_entry_rssi_threshold_5GHz">-85</integer>
+</resources>
-- 
2.30.1


From 6a3b5150f663e1b9278f431345701a5080abc217 Mon Sep 17 00:00:00 2001
From: Albert I <kras@raphielgang.org>
Date: Thu, 11 Feb 2021 12:20:38 +0800
Subject: [PATCH 2/5] version: Fix DOT_BUILD_DATE_UTC

The whole fetching situation is already complicated. This is made worse by
unnecessary use of `date -d` with all variables already fetched separately.

Just re-use them, seriously.

[jokes on you CRLF, this file was made on Windows, hence I have to run unix2dos]
Signed-off-by: Albert I <kras@raphielgang.org>
Change-Id: I621149f05177074afe41072fd73ae438b2e99213
---
 config/version.mk | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/config/version.mk b/config/version.mk
index e7636149..9de65825 100644
--- a/config/version.mk
+++ b/config/version.mk
@@ -25,7 +25,7 @@ DOT_DATE_MONTH := $(shell date -u +%m)
 DOT_DATE_DAY := $(shell date -u +%d)
 DOT_DATE_HOUR := $(shell date -u +%H)
 DOT_DATE_MINUTE := $(shell date -u +%M)
-DOT_BUILD_DATE_UTC := $(shell date -d '$(DOT_DATE_YEAR)-$(DOT_DATE_MONTH)-$(DOT_DATE_DAY) $(DOT_DATE_HOUR):$(DOT_DATE_MINUTE) UTC' +%s)
+DOT_BUILD_DATE_UTC := $(DOT_DATE_YEAR)-$(DOT_DATE_MONTH)-$(DOT_DATE_DAY) $(DOT_DATE_HOUR):$(DOT_DATE_MINUTE) UTC
 CUSTOM_BUILD_DATE := $(DOT_DATE_YEAR)$(DOT_DATE_MONTH)$(DOT_DATE_DAY)-$(DOT_DATE_HOUR)$(DOT_DATE_MINUTE)
 
 ifeq ($(DOT_OFFICIAL), true)
-- 
2.30.1


From 145bd7d2c244798a2638767f0ae09042026369a9 Mon Sep 17 00:00:00 2001
From: Albert I <kras@raphielgang.org>
Date: Thu, 11 Feb 2021 21:36:24 +0800
Subject: [PATCH 3/5] BoardConfigKernel: Revert bone-breaking changes

Perl libraries are in common folder ffs

Signed-off-by: Albert I <kras@raphielgang.org>
Change-Id: I160a4941b7a8bf2d2d85c8d177b92e4214634eb5
---
 config/BoardConfigKernel.mk | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/config/BoardConfigKernel.mk b/config/BoardConfigKernel.mk
index 30e4a6ec..4e4112a3 100644
--- a/config/BoardConfigKernel.mk
+++ b/config/BoardConfigKernel.mk
@@ -130,7 +130,7 @@ endif
 TOOLS_PATH_OVERRIDE := \
     PATH=$(BUILD_TOP)/prebuilts/tools-dot/$(HOST_OS)-x86/bin:$$PATH \
     LD_LIBRARY_PATH=$(BUILD_TOP)/prebuilts/tools-dot/$(HOST_OS)-x86/lib:$$LD_LIBRARY_PATH \
-    PERL5LIB=$(BUILD_TOP)/prebuilts/tools-dot/$(HOST_OS)-x86/lib/perl-base
+    PERL5LIB=$(BUILD_TOP)/prebuilts/tools-dot/common/perl-base
 
 # Set DTBO image locations so the build system knows to build them
 ifeq (true,$(filter true, $(TARGET_NEEDS_DTBOIMAGE) $(BOARD_KERNEL_SEPARATED_DTBO)))
-- 
2.30.1


From 48e11422c3a99aa9a4129a5bca0c92151d496a3e Mon Sep 17 00:00:00 2001
From: Albert I <kras@raphielgang.org>
Date: Wed, 17 Feb 2021 01:12:21 +0800
Subject: [PATCH 4/5] packages: Omit SystemUpdates for unofficial builds

Signed-off-by: Albert I <kras@raphielgang.org>
Change-Id: I48eadd5ff8841c56204d76f776d3beab181fe53b
---
 config/packages.mk | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/config/packages.mk b/config/packages.mk
index d620ab23..210cc4f8 100644
--- a/config/packages.mk
+++ b/config/packages.mk
@@ -75,7 +75,11 @@ PRODUCT_DEXPREOPT_SPEED_APPS += \
 
 # Dot Packages
 PRODUCT_PACKAGES += \
-    Customizations \
+    Customizations
+
+ifeq ($(DOT_BUILD_TYPE),OFFICIAL)
+PRODUCT_PACKAGES += \
     SystemUpdates
+endif
 
-include vendor/dot/config/overlay.mk
\ No newline at end of file
+include vendor/dot/config/overlay.mk
-- 
2.30.1


From 9d7e1f3ec6794c83178904a3d4fe642713f583b7 Mon Sep 17 00:00:00 2001
From: Albert I <kras@raphielgang.org>
Date: Mon, 15 Feb 2021 19:05:46 +0800
Subject: [PATCH 5/5] dnm

Signed-off-by: Albert I <kras@raphielgang.org>
Change-Id: I75e5175e48145499f677c956bc2d3e287fd595cf
---
 config/common.mk | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/config/common.mk b/config/common.mk
index 807f6b34..ec6219cc 100644
--- a/config/common.mk
+++ b/config/common.mk
@@ -102,6 +102,8 @@ DEVICE_PACKAGE_OVERLAYS += vendor/dot/overlay/common
 #Telephony
 $(call inherit-product, vendor/dot/config/telephony.mk)
 
+-include vendor/kud/config/common.mk
+
 # Packages
 include vendor/dot/config/packages.mk
 
-- 
2.30.1

